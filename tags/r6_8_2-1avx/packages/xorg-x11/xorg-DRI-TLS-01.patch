Index: xc/config/cf/X11.tmpl
===================================================================
RCS file: /cvs/dri/xc/xc/config/cf/X11.tmpl,v
retrieving revision 1.34
diff -u -d -r1.34 X11.tmpl
--- xc/config/cf/X11.tmpl	9 Apr 2004 00:18:44 -0000	1.34
+++ xc/config/cf/X11.tmpl	11 Jul 2004 19:02:31 -0000
@@ -502,6 +502,9 @@
 #ifndef BuildOSMesaLib
 #define BuildOSMesaLib		BuildGlxExt
 #endif
+#ifndef GlxUseThreadLocalStorage
+#define GlxUseThreadLocalStorage NO
+#endif
 #ifndef BuildGLULibrary
 #define BuildGLULibrary		(BuildGLXLibrary && BuildLibraries && \
 				 HasCplusplus)
@@ -784,8 +787,13 @@
 #ifndef ExtraConnectionDefs
 #define ExtraConnectionDefs $(STICKY_DEFINES) $(FCHOWN_DEFINES) IPv6Flags
 #endif
+#if GlxUseThreadLocalStorage
+#define GlxTLSDefines -DGLX_USE_TLS
+#else
+#define GlxTLSDefines /**/
+#endif
 #ifndef ProjectThreadsDefines
-#define ProjectThreadsDefines -DXTHREADS
+#define ProjectThreadsDefines -DXTHREADS GlxTLSDefines
 #endif
 #ifndef FontOSDefines
 #define FontOSDefines /**/
@@ -2149,6 +2157,9 @@
 #ifndef BuildLibGlxWithoutPIC
 #define BuildLibGlxWithoutPIC	NO
 #endif
+#ifndef GlxUseThreadLocalStorage
+#define GlxUseThreadLocalStorage NO
+#endif
 #if BuildLibGlxWithoutPIC && SharedLibGlx
 #define SharedLibGlxWithoutPIC	YES
 #else
Index: lib/GL/GL/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/GL/Imakefile,v
retrieving revision 1.10
diff -u -d -r1.10 Imakefile
--- xc/lib/GL/GL/Imakefile	28 May 2004 18:41:41 -0000	1.10
+++ xc/lib/GL/GL/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -214,30 +214,35 @@
 #undef _LinkBuildLibrary
 #define _LinkBuildLibrary(lib) LinkBuildLibrary(lib)
 
+#if GlxUseThreadLocalStorage
+ LIBSUBDIR = /tls
+#else
+ LIBSUBDIR =
+#endif
 
 #if NormalLibGlx
 NormalLibraryTarget($(LIBNAME),$(UOBJS))
-InstallLibrary($(LIBNAME),$(USRLIBDIR))
+InstallLibrary($(LIBNAME),$(USRLIBDIR)$(LIBSUBDIR))
 #endif
 #if SharedLibGlx
 SharedDepLibraryTarget($(LIBNAME),$(SOREV),$(OBJS),$(OBJS) $(THREADOBJS),.,.)
-InstallSharedLibrary($(LIBNAME),$(SOREV),$(SHLIBDIR))
+InstallSharedLibrary($(LIBNAME),$(SOREV),$(SHLIBDIR)$(LIBSUBDIR))
 #if LinkGLToUsrLib && AlternateUsrLibDir
 install::
-	MakeDir($(DESTDIR)$(SYSTEMUSRLIBDIR))
-	$(RM) $(DESTDIR)$(SYSTEMUSRLIBDIR)/lib$(LIBNAME).so
-	$(LN) $(SHLIBDIR)/lib$(LIBNAME).so $(DESTDIR)$(SYSTEMUSRLIBDIR)/lib$(LIBNAME).so || true
-	$(RM) $(DESTDIR)$(SYSTEMUSRLIBDIR)/lib$(LIBNAME).so.1
-	$(LN) $(SHLIBDIR)/lib$(LIBNAME).so.1 $(DESTDIR)$(SYSTEMUSRLIBDIR)/lib$(LIBNAME).so.1 || true
+	MakeDir($(DESTDIR)$(SYSTEMUSRLIBDIR)$(LIBSUBDIR))
+	$(RM) $(DESTDIR)$(SYSTEMUSRLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so
+	$(LN) $(SHLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so $(DESTDIR)$(SYSTEMUSRLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so || true
+	$(RM) $(DESTDIR)$(SYSTEMUSRLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so.1
+	$(LN) $(SHLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so.1 $(DESTDIR)$(SYSTEMUSRLIBDIR)$(LIBSUBDIR)/lib$(LIBNAME).so.1 || true
 #endif
 #endif
 #if DebugLibGlx
 DebuggedLibraryTarget($(LIBNAME),$(DOBJS))
-InstallLibrary($(LIBNAME)_d,$(USRLIBDIR))
+InstallLibrary($(LIBNAME)_d,$(USRLIBDIR)$(LIBSUBDIR))
 #endif
 #if ProfileLibGlx
 ProfiledLibraryTarget($(LIBNAME),$(POBJS))
-InstallLibrary($(LIBNAME)_p,$(USRLIBDIR))
+InstallLibrary($(LIBNAME)_p,$(USRLIBDIR)$(LIBSUBDIR))
 #endif
 
 
Index: xc/lib/GL/glx/dri_glx.c
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/glx/dri_glx.c,v
retrieving revision 1.1
diff -u -d -r1.1 dri_glx.c
--- xc/lib/GL/glx/dri_glx.c	28 May 2004 18:41:41 -0000	1.1
+++ xc/lib/GL/glx/dri_glx.c	11 Jul 2004 19:02:31 -0000
@@ -119,18 +119,26 @@
 
 
 
-/*
- * Extract the ith directory path out of a colon-separated list of
- * paths.
- * Input:
- *   index - index of path to extract (starting at zero)
- *   paths - the colon-separated list of paths
- *   dirLen - max length of result to store in <dir>
- * Output:
- *   dir - the extracted directory path, dir[0] will be zero when
- *         extraction fails.
+/**
+ * Extract the ith directory path out of a colon-separated list of paths.  No
+ * more than \c dirLen characters, including the terminating \c NUL, will be
+ * written to \c dir.
+ *
+ * \param index  Index of path to extract (starting at zero)
+ * \param paths  The colon-separated list of paths
+ * \param dirLen Maximum length of result to store in \c dir
+ * \param dir    Buffer to hold the extracted directory path
+ *
+ * \returns
+ * The number of characters that would have been written to \c dir had there
+ * been enough room.  This does not include the terminating \c NUL.  When
+ * extraction fails, zero will be returned.
+ * 
+ * \todo
+ * It seems like this function could be rewritten to use \c strchr.
  */
-static void ExtractDir(int index, const char *paths, int dirLen, char *dir)
+static size_t
+ExtractDir(int index, const char *paths, int dirLen, char *dir)
 {
    int i, len;
    const char *start, *end;
@@ -146,7 +154,7 @@
       else if (*start == 0) {
          /* end of string and couldn't find ith colon */
          dir[0] = 0;
-         return;
+         return 0;
       }
       else {
          start++;
@@ -168,22 +176,27 @@
       len = dirLen - 1;
    strncpy(dir, start, len);
    dir[len] = 0;
+
+   return( end - start );
 }
 
 
-/*
- * Try to dlopen() the named driver.  This function adds the
- * "_dri.so" suffix to the driver name and searches the
- * directories specified by the LIBGL_DRIVERS_PATH env var
- * in order to find the driver.
- * Input:
- *   driverName - a name like "tdfx", "i810", "mga", etc.
- * Return:
- *   handle from dlopen, or NULL if driver file not found.
+/**
+ * Try to \c dlopen the named driver.
+ *
+ * This function adds the "_dri.so" suffix to the driver name and searches the
+ * directories specified by the \c LIBGL_DRIVERS_PATH environment variable in
+ * order to find the driver.
+ *
+ * \param driverName - a name like "tdfx", "i810", "mga", etc.
+ *
+ * \returns
+ * A handle from \c dlopen, or \c NULL if driver file not found.
  */
 static __DRIdriver *OpenDriver(const char *driverName)
 {
    char *libPaths = NULL;
+   char libDir[1000];
    int i;
    __DRIdriver *driver;
 
@@ -204,16 +217,27 @@
    if (!libPaths)
       libPaths = DEFAULT_DRIVER_DIR;
 
-   for (i = 0; ; i++) {
-      char libDir[1000], realDriverName[200];
-      void *handle;
-      ExtractDir(i, libPaths, 1000, libDir);
-      if (!libDir[0])
-         break; /* ran out of paths to search */
-      snprintf(realDriverName, 200, "%s/%s_dri.so", libDir, driverName);
+   for ( i = 0 ; ExtractDir(i, libPaths, 1000, libDir) != 0 ; i++ ) {
+      char realDriverName[200];
+      void *handle = NULL;
+
+      
+      /* If TLS support is enabled, try to open the TLS version of the driver
+       * binary first.  If that fails, try the non-TLS version.
+       */
+#ifdef GLX_USE_TLS
+      snprintf(realDriverName, 200, "%s/tls/%s_dri.so", libDir, driverName);
       InfoMessageF("OpenDriver: trying %s\n", realDriverName);
       handle = dlopen(realDriverName, RTLD_NOW | RTLD_GLOBAL);
-      if (handle) {
+#endif
+
+      if ( handle == NULL ) {
+	 snprintf(realDriverName, 200, "%s/%s_dri.so", libDir, driverName);
+	 InfoMessageF("OpenDriver: trying %s\n", realDriverName);
+	 handle = dlopen(realDriverName, RTLD_NOW | RTLD_GLOBAL);
+      }
+
+      if ( handle != NULL ) {
          /* allocate __DRIdriver struct */
          driver = (__DRIdriver *) Xmalloc(sizeof(__DRIdriver));
          if (!driver)
Index: xc/lib/GL/mesa/drivers/dri/ffb/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/ffb/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/ffb/Imakefile	27 May 2004 22:50:15 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/ffb/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -58,15 +58,21 @@
 SubdirLibraryRule($(FFBOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = ffb_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _ffb_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/gamma/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/gamma/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/gamma/Imakefile	27 May 2004 22:50:16 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/gamma/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -58,15 +58,21 @@
 SubdirLibraryRule($(GAMMAOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = gamma_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _gamma_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/i810/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/i810/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/i810/Imakefile	27 May 2004 22:50:16 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/i810/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -58,15 +58,21 @@
 SubdirLibraryRule($(I810OBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = i810_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _i810_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/mach64/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/mach64/Imakefile,v
retrieving revision 1.4
diff -u -d -r1.4 Imakefile
--- xc/lib/GL/mesa/drivers/dri/mach64/Imakefile	27 May 2004 22:50:16 -0000	1.4
+++ xc/lib/GL/mesa/drivers/dri/mach64/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -58,15 +58,21 @@
 SubdirLibraryRule($(Mach64OBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = mach64_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _mach64_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/mga/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/mga/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/mga/Imakefile	27 May 2004 22:50:16 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/mga/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -59,15 +59,21 @@
 SubdirLibraryRule($(MGAOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = mga_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _mga_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/r128/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/r128/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/r128/Imakefile	27 May 2004 22:50:16 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/r128/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -58,15 +58,21 @@
 SubdirLibraryRule($(R128OBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = r128_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _r128_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/r200/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/r200/Imakefile,v
retrieving revision 1.7
diff -u -d -r1.7 Imakefile
--- xc/lib/GL/mesa/drivers/dri/r200/Imakefile	27 May 2004 22:50:16 -0000	1.7
+++ xc/lib/GL/mesa/drivers/dri/r200/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -59,15 +59,21 @@
 
 ObjectFromAsmSource(r200_vtxtmp_x86, NullParameter)
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = r200_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _r200_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/radeon/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/radeon/Imakefile,v
retrieving revision 1.7
diff -u -d -r1.7 Imakefile
--- xc/lib/GL/mesa/drivers/dri/radeon/Imakefile	27 May 2004 22:50:16 -0000	1.7
+++ xc/lib/GL/mesa/drivers/dri/radeon/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -59,15 +59,21 @@
 
 ObjectFromAsmSource(radeon_vtxtmp_x86, NullParameter)
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = radeon_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _radeon_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/savage/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/savage/Imakefile,v
retrieving revision 1.3
diff -u -d -r1.3 Imakefile
--- xc/lib/GL/mesa/drivers/dri/savage/Imakefile	27 May 2004 22:50:16 -0000	1.3
+++ xc/lib/GL/mesa/drivers/dri/savage/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -59,15 +59,21 @@
 SubdirLibraryRule($(SAVAGEOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = savage_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _savage_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/sis/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/sis/Imakefile,v
retrieving revision 1.6
diff -u -d -r1.6 Imakefile
--- xc/lib/GL/mesa/drivers/dri/sis/Imakefile	27 May 2004 22:50:16 -0000	1.6
+++ xc/lib/GL/mesa/drivers/dri/sis/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -61,15 +61,21 @@
 SubdirLibraryRule($(SISOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = sis_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _sis_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/tdfx/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/tdfx/Imakefile,v
retrieving revision 1.7
diff -u -d -r1.7 Imakefile
--- xc/lib/GL/mesa/drivers/dri/tdfx/Imakefile	27 May 2004 22:50:16 -0000	1.7
+++ xc/lib/GL/mesa/drivers/dri/tdfx/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -57,15 +57,21 @@
 SubdirLibraryRule($(TDFXOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = tdfx_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _tdfx_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 
Index: xc/lib/GL/mesa/drivers/dri/unichrome/Imakefile
===================================================================
RCS file: /cvs/dri/xc/xc/lib/GL/mesa/drivers/dri/unichrome/Imakefile,v
retrieving revision 1.1
diff -u -d -r1.1 Imakefile
--- xc/lib/GL/mesa/drivers/dri/unichrome/Imakefile	16 Jun 2004 15:10:04 -0000	1.1
+++ xc/lib/GL/mesa/drivers/dri/unichrome/Imakefile	11 Jul 2004 19:02:31 -0000
@@ -61,15 +61,21 @@
 SubdirLibraryRule($(VIAOBJS))
 NormalLintTarget($(SRCS))
 
+#if GlxUseThreadLocalStorage
+ MODULESUBDIR = dri/tls
+#else
+ MODULESUBDIR = dri
+#endif
+
 #if !GlxUseBuiltInDRIDriver
 LIBNAME = unichrome_dri.so
 SharedDriModuleTarget($(LIBNAME),DONE $(OBJS),$(OBJS))
-InstallDynamicModule($(LIBNAME),$(MODULEDIR),dri)
+InstallDynamicModule($(LIBNAME),$(MODULEDIR),$(MODULESUBDIR))
 
 #ifdef GlxSoProf
 SOPROF_LIBNAME = _unichrome_dri_p
 NormalDepLibraryTarget($(SOPROF_LIBNAME),DONE $(OBJS),$(OBJS))
-InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/dri)
+InstallLibrary($(SOPROF_LIBNAME),$(MODULEDIR)/$(MODULESUBDIR))
 #endif
 #endif
 

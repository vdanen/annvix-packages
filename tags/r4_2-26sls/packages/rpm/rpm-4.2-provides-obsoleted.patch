--- rpm-4.2/rpmdb/rpmdb.c.fpons	2003-08-04 18:26:47.000000000 +0200
+++ rpm-4.2/rpmdb/rpmdb.c	2003-08-04 18:26:54.000000000 +0200
@@ -3712,7 +3712,7 @@
     }
     dbpath = rootdbpath = rpmGetPath(prefix, tfn, NULL);
     if (!(prefix[0] == '/' && prefix[1] == '\0'))
-	dbpath += strlen(prefix);
+        dbpath += strlen(prefix) - 1; /* FIXME: a trailing / is always added */
     tfn = _free(tfn);
 
     /*@-nullpass@*/
--- rpm-4.2/lib/depends.c.fpons	2003-08-04 18:26:18.000000000 +0200
+++ rpm-4.2/lib/depends.c	2003-08-04 18:26:23.000000000 +0200
@@ -254,7 +254,7 @@
 
     /* On upgrade, erase older packages of same color (if any). */
 
-    mi = rpmtsInitIterator(ts, RPMTAG_PROVIDENAME, rpmteN(p), 0);
+    mi = rpmtsInitIterator(ts, RPMTAG_NAME, rpmteN(p), 0);
     while((oh = rpmdbNextIterator(mi)) != NULL) {
 
 	/* Ignore colored packages not in our rainbow. */
@@ -288,7 +288,8 @@
 	if (!strcmp(rpmteN(p), Name))
 	    continue;
 
-	mi = rpmtsInitIterator(ts, RPMTAG_PROVIDENAME, Name, 0);
+	/* avoid obsoleting virtual provides (Mandrake packaging policies is not compliant) */
+	mi = rpmtsInitIterator(ts, RPMTAG_NAME, Name, 0);
 
 	xx = rpmdbPruneIterator(mi,
 	    ts->removedPackages, ts->numRemovedPackages, 1);
@@ -304,8 +305,8 @@
 	     * If no obsoletes version info is available, match all names.
 	     */
 	    if (rpmdsEVR(obsoletes) == NULL
-	     || rpmdsAnyMatchesDep(oh, obsoletes, _rpmds_nopromote))
-		xx = removePackage(ts, oh, rpmdbGetIteratorOffset(mi), pkgKey);
+		|| rpmdsNVRMatchesDep(oh, obsoletes, _rpmds_nopromote))
+	        xx = removePackage(ts, oh, rpmdbGetIteratorOffset(mi), pkgKey);
 	}
 	mi = rpmdbFreeIterator(mi);
     }
--- rpm-4.2/lib/rpmts.c.fpons	2003-08-04 18:26:35.000000000 +0200
+++ rpm-4.2/lib/rpmts.c	2003-08-04 18:26:40.000000000 +0200
@@ -725,6 +725,8 @@
 	}
 	rootLen = strlen(rootDir);
 
+	/* FIXME: if multiple / are present, other code will be unhappy */
+
 /*@-branchstate@*/
 	/* Make sure that rootDir has trailing / */
 	if (!(rootLen && rootDir[rootLen - 1] == '/')) {

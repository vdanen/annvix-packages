#!/bin/sh
PATH="/sbin:/usr/sbin:/bin:/usr/bin:$PATH"

# this runs postgresql under supervise

if [ -f /etc/sysconfig/postgresql ]; then
  . /etc/sysconfig/postgresql
else
  PGPORT=5432
  PGDATA="/var/lib/pgsql/data"
  USETCP="0"
  USESSL="0"
fi

if [ ! -f $PGDATA/PG_VERSION ] && [ ! -d $PGDATA/base/template1 ]; then
  PGDATA="/var/lib/pgsql/data"
fi

rm -f /tmp/.s.PGSQL.$PGPORT >/dev/null

if [ "$USETCP" == "1" ]; then
  OPTS="-i -p $PGPORT"
fi

if [ "$USESSL" == "1" ] && [ -f $PGDATA/server.crt ]; then
  OPTS="$OPTS -l"
fi

# when we receive the signal to shutdown, remove the postmaster pid
trap 'rm -f $PGDATA/postmaster.pid'

exec /usr/bin/setuidgid postgres /usr/bin/postmaster -D $PGDATA $OPTS 2>&1
